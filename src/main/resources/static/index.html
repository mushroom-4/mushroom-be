<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <!-- SockJSì™€ stomp.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (CDN ì‚¬ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    #messages {
      list-style: none;
      padding: 0;
    }

    #messages li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
<h2>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
<label for="tokenInput">í† í°:</label>
<input type="text" id="tokenInput" placeholder="í† í° ì…ë ¥">
<button onclick="connect()">ğŸ”— ì—°ê²°</button> <!-- âœ… ì—°ê²° ë²„íŠ¼ ì¶”ê°€ -->
<br><br>
<label for="chatRoomId">ì±„íŒ…ë°© ID:</label>
<input type="text" id="chatRoomId" value="1" size="3">
<br><br>
<label for="messageInput">ë©”ì‹œì§€:</label>
<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
<button id="sendButton" onclick="sendMessage()" disabled>ğŸ’¬ ì „ì†¡</button> <!-- âœ… ì´ˆê¸°ì—ëŠ” ë¹„í™œì„±í™” -->
<hr>
<ul id="messages"></ul>

<script>
  let stompClient = null;

  function connect() {
    const token = document.getElementById('tokenInput').value;

    if (!token) {
      console.error("ğŸš¨ í† í°ì´ ì—†ìŠµë‹ˆë‹¤!");
      alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }

    console.log("ğŸ“Œ ì—°ê²° ìš”ì²­: ws://localhost:8080/ws");
    console.log("ğŸ“Œ ë³´ë‚¼ í† í°:", token);

    const socket = new SockJS('/ws'); // ì›¹ì†Œì¼“ ì—”ë“œí¬ì¸íŠ¸ ì§€ì •
    stompClient = Stomp.over(socket);

    stompClient.debug = function (str) {
      console.log("ğŸ“Œ [STOMP Debug]", str);
    };

    const headers = {'Authorization': 'Bearer ' + token};
    console.log("[Header] : ", headers)

    stompClient.connect(headers, function (frame) {
      console.log('âœ… STOMP ì—°ê²° ì„±ê³µ:', frame);

      const chatRoomId = document.getElementById("chatRoomId").value;
      stompClient.subscribe('/sub/chats/' + chatRoomId, function (messageOutput) {
        showMessage(JSON.parse(messageOutput.body));
      });

      // STOMP ì—°ê²° ì™„ë£Œ í›„ ì „ì†¡ ë²„íŠ¼ í™œì„±í™”
      document.getElementById("sendButton").disabled = false;
    }, function (error) {
      console.error('ğŸš¨ STOMP ì—°ê²° ì˜¤ë¥˜:', error);
      alert("STOMP ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    });
  }

  function sendMessage() {
    if (!stompClient || !stompClient.connected) {
      console.error("ğŸš¨ STOMP ì—°ê²°ì´ ì•ˆ ë˜ì–´ ìˆìŠµë‹ˆë‹¤! ë¨¼ì € connect()ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
      alert("STOMP ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°ì„ ì‹œë„í•˜ì„¸ìš”!");
      return;
    }

    const chatRoomId = document.getElementById("chatRoomId").value;
    const message = document.getElementById("messageInput").value;

    if (!message.trim()) {
      console.warn("ğŸš¨ ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!");
      return;
    }

    console.log(`ğŸ“Œ [Client] ë©”ì‹œì§€ ì „ì†¡: /pub/chats/${chatRoomId}`);

    const payload = JSON.stringify({message: message});
    stompClient.send("/pub/chats/" + chatRoomId, {}, payload);
    document.getElementById("messageInput").value = '';
  }

  function showMessage(message) {
    const messagesList = document.getElementById("messages");
    const messageElement = document.createElement('li');
    // ChatMessageResì˜ nicknameì´ ì—†ìœ¼ë©´ 'ìµëª…'ìœ¼ë¡œ í‘œì‹œ
    messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message.nickname
    || 'ìµëª…'}: ${message.message}`;
    messagesList.appendChild(messageElement);
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° (ì—°ê²° ì „ì— í† í°ì„ ì…ë ¥í•˜ê³  ì‹¶ë‹¤ë©´ connect() í˜¸ì¶œ ì‹œì ì„ ì¡°ì •)
  connect();
</script>
</body>
</html>