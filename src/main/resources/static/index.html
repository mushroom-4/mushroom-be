<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <!-- SockJSì™€ stomp.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (CDN ì‚¬ìš©) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    /* âœ… ì±„íŒ…ì°½ê³¼ ì ‘ì†ì ëª©ë¡ì„ ê°€ë¡œ ë°°ì¹˜ */
    #container {
      display: flex;
      flex-direction: row; /* ê°€ë¡œ ì •ë ¬ */
      justify-content: space-between;
      align-items: flex-start;
      width: 100%;
      max-width: 1200px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
      margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
    }

    /* âœ… ë©”ì‹œì§€ ëª©ë¡ì„ í™”ë©´ ëŒ€ë¶€ë¶„ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
    #messagesContainer {
      flex-grow: 1; /* ë‚¨ëŠ” ê³µê°„ì„ ìµœëŒ€í•œ ì°¨ì§€ */
      padding-right: 20px;
    }

    /* âœ… ì ‘ì†ì ëª©ë¡ UI ì •ë¦¬ */
    #userListContainer {
      width: 250px; /* ì ‘ì†ì ëª©ë¡ í¬ê¸° ì¡°ì ˆ */
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      text-align: center; /* ì œëª© ê°€ìš´ë° ì •ë ¬ */
    }

    /* âœ… ì ‘ì†ì ìˆ˜ë¥¼ ëª©ë¡ ìœ„ë¡œ ì •ë ¬ */
    #userCount {
      display: block; /* ëª©ë¡ ìœ„ì— í‘œì‹œ */
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* âœ… ì ‘ì†ì ëª©ë¡ ìŠ¤íƒ€ì¼ */
    #userList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    /* âœ… ê°œë³„ ì‚¬ìš©ì í•­ëª© */
    .user-item {
      display: flex;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #ddd;
      text-align: left; /* ì‚¬ìš©ì ì´ë¦„ ì™¼ìª½ ì •ë ¬ */
    }

    .user-item img {
      max-width: 40px;
      max-height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .user-item span {
      font-weight: bold;
      color: #333;
    }

    /* ë‚´ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½ ì •ë ¬, ë°°ê²½ìƒ‰) */
    .my-message {
      align-self: flex-end;
      text-align: right;
      margin-left: auto;
      background-color: #d1ffd1; /* ì˜ˆì‹œ ë°°ê²½ìƒ‰ ì¶”ê°€ */
    }

    /* ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ (ì™¼ìª½ ì •ë ¬, ë°°ê²½ìƒ‰) */
    .other-message {
      align-self: flex-start;
      text-align: left;
      margin-right: auto;
      background-color: #f1f1f1; /* ì˜ˆì‹œ ë°°ê²½ìƒ‰ ì¶”ê°€ */
    }

    /* ë‚ ì§œ í—¤ë” ìŠ¤íƒ€ì¼ */
    .date-header {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      background-color: #fff;
      color: #888;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ë‘¥ê·¼ ì´ë¯¸ì§€ ì˜ˆì‹œ */
    .chat-img {
      max-width: 50px;
      max-height: 50px;
      border-radius: 50%;
      margin-left: 10px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<!-- âœ… ì±„íŒ…ì°½ & ì ‘ì†ì ëª©ë¡ì„ ê°€ë¡œ ë°°ì¹˜í•˜ëŠ” ì»¨í…Œì´ë„ˆ -->
<div id="container">
  <!-- âœ… ë©”ì‹œì§€ ì˜ì—­ -->
  <div id="messagesContainer">
    <h2>STOMP ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>
    <label for="tokenInput">í† í°:</label>
    <input type="text" id="tokenInput" placeholder="í† í° ì…ë ¥">
    <button onclick="connect()">ğŸ”— ì—°ê²°</button>
    <br><br>
    <label for="chatRoomId">ì±„íŒ…ë°© ID:</label>
    <input type="text" id="chatRoomId" value="1" size="3">
    <br><br>
    <label for="messageInput">ë©”ì‹œì§€:</label>
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button id="sendButton" onclick="sendMessage()" disabled>ğŸ’¬ ì „ì†¡</button>
    <hr>
    <ul id="messages"></ul>
  </div>

  <!-- âœ… í˜„ì¬ ì ‘ì†ì ëª©ë¡ (ì˜¤ë¥¸ìª½ ë°°ì¹˜) -->
  <div id="userListContainer">
    <h3 id="userCount">í˜„ì¬ ì ‘ì†ì: 0ëª…</h3>
    <h3>í˜„ì¬ ì ‘ì†ì ëª©ë¡</h3>
    <ul id="userList">
      <li>í˜„ì¬ ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>
    </ul>
  </div>
</div>

<script>
  let stompClient = null;
  let subscription = null;
  let userListSubscription = null;
  let myUserId = null;
  let lastDateKey = null;  // ë§ˆì§€ë§‰ìœ¼ë¡œ í‘œì‹œí•œ ë‚ ì§œ (YYYY-MM-DD)

  /**
   * connect: STOMP ì—°ê²° ë° êµ¬ë…
   */
  function connect(options) {
    const token = document.getElementById('tokenInput').value;

    if (!token) {
      console.error("ğŸš¨ í† í°ì´ ì—†ìŠµë‹ˆë‹¤!");
      alert("í† í°ì„ ì…ë ¥í•˜ì„¸ìš”!");
      return;
    }

    console.log("ğŸ“Œ ì—°ê²° ìš”ì²­: ws://localhost:8080/ws");
    console.log("ğŸ“Œ ë³´ë‚¼ í† í°:", token);

    // í† í°ì—ì„œ ì‚¬ìš©ì ID ì¶”ì¶œ
    myUserId = Number(getUserIdFromToken(token));
    console.log("í˜„ì¬ ì‚¬ìš©ì ID:", myUserId);

    const socket = new SockJS('/ws'); // ì›¹ì†Œì¼“ ì—”ë“œí¬ì¸íŠ¸ ì§€ì •
    stompClient = Stomp.over(socket);

    stompClient.debug = function (str) {
      console.log("ğŸ“Œ [STOMP Debug]", str);
    };

    const headers = {'Authorization': 'Bearer ' + token};
    console.log("[Header] : ", headers)

    stompClient.connect(headers, function (frame) {
      console.log('âœ… STOMP ì—°ê²° ì„±ê³µ:', frame);

      const chatRoomId = document.getElementById("chatRoomId").value;

      // âœ… ê¸°ì¡´ êµ¬ë… í•´ì œ í›„ ë‹¤ì‹œ êµ¬ë…
      if (subscription) {
        subscription.unsubscribe();
      }
      if (userListSubscription) {
        userListSubscription.unsubscribe();
      }

      subscription = stompClient.subscribe('/ws/sub/chats/' + chatRoomId,
          handleSubscriptionMessage);
      console.log(`âœ… ë©”ì‹œì§€ êµ¬ë… ì„±ê³µ: /ws/sub/chats/${chatRoomId}`);

      // âœ… ì‚¬ìš©ì ëª©ë¡ êµ¬ë… (í˜„ì¬ ì ‘ì†ì ëª©ë¡ ìˆ˜ì‹ )
      userListSubscription = stompClient.subscribe('/ws/sub/chatrooms/' + chatRoomId + '/users',
          handleUserListUpdate);
      console.log(`âœ… ì‚¬ìš©ì ëª©ë¡ êµ¬ë… ì„±ê³µ: /ws/sub/chatrooms/${chatRoomId}/users`);

      // STOMP ì—°ê²° ì™„ë£Œ í›„ ì „ì†¡ ë²„íŠ¼ í™œì„±í™”
      document.getElementById("sendButton").disabled = false;

      // âœ… ì´ì „ ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° (REST API í˜¸ì¶œ)
      fetchChatHistory(chatRoomId);

      // âœ… ì„œë²„ì— í˜„ì¬ ì ‘ì†ì ëª©ë¡ ìš”ì²­
      stompClient.send(`/ws/pub/chatrooms/${chatRoomId}/users`, {}, {});

    }, function (error) {
      console.error('ğŸš¨ STOMP ì—°ê²° ì˜¤ë¥˜:', error);
      alert("STOMP ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    });
  }

  /**
   * handleUserListUpdate: ì„œë²„ì—ì„œ ì ‘ì†ì ëª©ë¡ì„ ìˆ˜ì‹ í•˜ì—¬ ì—…ë°ì´íŠ¸
   */
  function handleUserListUpdate(message) {
    const data = JSON.parse(message.body);
    console.log("âœ… í˜„ì¬ ì ‘ì†ì ëª©ë¡ ìˆ˜ì‹ :", data);
    updateUserList(data.userInfoRes, data.currentUserCount);
  }

  /**
   * updateUserList: í™”ë©´ì˜ ì ‘ì†ì ëª©ë¡ì„ ê°±ì‹ 
   */
  function updateUserList(userList, currentUserCount) {
    const userListDiv = document.getElementById("userList"); // âœ… ì ‘ì†ì ëª©ë¡
    const userCountElement = document.getElementById("userCount"); // âœ… ì ‘ì†ì ìˆ˜
    userListDiv.innerHTML = "";

    // âœ… ì ‘ì†ì ìˆ˜ ì—…ë°ì´íŠ¸
    userCountElement.textContent = `í˜„ì¬ ì ‘ì†ì: ${currentUserCount}ëª…`;

    // âœ… ëª©ë¡ ì´ˆê¸°í™”
    userListDiv.innerHTML = "";

    if (!userList || userList.length === 0) {
      userListDiv.innerHTML = "í˜„ì¬ ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    userList.forEach(user => {
      const userItem = document.createElement("li");
      userItem.classList.add("user-item");

      const userImage = document.createElement("img");
      userImage.src = user.imageUrl
          || "https://yeim-vpc-bucket-240130.s3.ap-northeast-2.amazonaws.com/public/12b545cf-2687-46e6-8c4d-aecef88d762b.JPG"; // ê¸°ë³¸ ì´ë¯¸ì§€

      const userName = document.createElement("span");
      userName.textContent = user.nickname;

      userItem.appendChild(userImage);
      userItem.appendChild(userName);

      console.log(`âœ… ì ‘ì†ì ì¶”ê°€ë¨: ${user.nickname}`); // ğŸ” ë””ë²„ê¹…ìš© ë¡œê·¸ ì¶”ê°€

      userListDiv.appendChild(userItem);
    });
  }

  /**
   * handleSubscriptionMessage: ì„œë²„ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹  ì‹œ í˜¸ì¶œ
   *    - ë©”ì‹œì§€ê°€ ë°°ì—´ì´ë©´ ê°ê° ì²˜ë¦¬, ë‹¨ì¼ì´ë©´ ê·¸ëŒ€ë¡œ ì²˜ë¦¬
   */
  function handleSubscriptionMessage(messageOutput) {
    const data = JSON.parse(messageOutput.body);

    // ì—ëŸ¬ ë©”ì‹œì§€ì¸ ê²½ìš° ê²½ê³ ì°½ í‘œì‹œ
    if (data.messageType === "ERROR") {
      if (data.senderId === myUserId) {
        alert(data.message);
      }
      return;
    }

    appendMessage(data);
  }

  /**
   * sendMessage: ë©”ì‹œì§€ ì „ì†¡
   */
  function sendMessage() {
    if (!stompClient || !stompClient.connected) {
      console.error("ğŸš¨ STOMP ì—°ê²°ì´ ì•ˆ ë˜ì–´ ìˆìŠµë‹ˆë‹¤! ë¨¼ì € connect()ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.");
      alert("STOMP ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°ì„ ì‹œë„í•˜ì„¸ìš”!");
      return;
    }

    const chatRoomId = document.getElementById("chatRoomId").value;
    const message = document.getElementById("messageInput").value;

    if (!message.trim()) {
      console.warn("ğŸš¨ ë©”ì‹œì§€ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤!");
      return;
    }

    console.log(`ğŸ“Œ [Client] ë©”ì‹œì§€ ì „ì†¡: /ws/pub/chats/${chatRoomId}`);

    const payload = JSON.stringify({message: message});
    stompClient.send("/ws/pub/chats/" + chatRoomId, {}, payload);
    document.getElementById("messageInput").value = '';
  }

  /**
   * appendMessage: ìˆ˜ì‹ ëœ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œ
   *    - ë‚ ì§œê°€ ë‹¬ë¼ì§€ë©´ ë‚ ì§œ í—¤ë” ì¶”ê°€
   *    - ë‚´ ë©”ì‹œì§€ì¸ì§€ ì—¬ë¶€ì— ë”°ë¼ CSS í´ë˜ìŠ¤ êµ¬ë¶„
   */
  function appendMessage(msg) {
    const messagesList = document.getElementById("messages");
    // ì‹¤ì œ ë©”ì‹œì§€ í‘œì‹œ
    const messageElement = document.createElement('li');

    // ë‚ ì§œ í‚¤ ì¶”ì¶œ (YYYY-MM-DD)
    const dateKey = formatDateKey(msg.sendDateTime);

    // ë‚ ì§œê°€ ë°”ë€Œë©´ í—¤ë” ì¶”ê°€
    if (!lastDateKey || lastDateKey !== dateKey) {
      appendDateHeader(dateKey);
      lastDateKey = dateKey;
    }

    // dateTimeì„ ë¡œì»¬ ì‹œê°„ ë¬¸ìì—´ë¡œ ë³€í™˜
    const timeString = msg.sendDateTime ? new Date(msg.sendDateTime).toLocaleTimeString()
        : new Date().toLocaleTimeString();

    // ë‚´ ë©”ì‹œì§€ ì—¬ë¶€: myUserIdì™€ msg.senderId ë¹„êµ
    const isMyMessage = myUserId !== null && msg.senderId === myUserId;

    // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ êµ¬ì„±
    messageElement.textContent = `[${timeString}] ${msg.nickname || 'ìµëª…'}: ${msg.message}`;

    // ë‚´ ë©”ì‹œì§€ì™€ íƒ€ ë©”ì‹œì§€ êµ¬ë¶„ (CSS í´ë˜ìŠ¤ ì ìš©)
    messageElement.className = isMyMessage ? "my-message" : "other-message";

    messagesList.appendChild(messageElement);
    console.log("ë©”ì‹œì§€ ì¶”ê°€:", msg);
  }

  /**
   * appendDateHeader: ë‚ ì§œ í—¤ë”(li ìš”ì†Œ) ì¶”ê°€
   */
  function appendDateHeader(dateKey) {
    const messagesList = document.getElementById("messages");
    const dateHeaderEl = document.createElement('li');
    dateHeaderEl.className = "date-header";
    dateHeaderEl.textContent = dateKey; // ì˜ˆ: 2025-02-21
    messagesList.appendChild(dateHeaderEl);
  }

  /**
   *  formatDateKey: YYYY-MM-DD í˜•íƒœë¡œ ë‚ ì§œ í‚¤ë¥¼ ì¶”ì¶œ
   */
  function formatDateKey(dateTimeStr) {
    if (!dateTimeStr) {
      return new Date().toISOString().slice(0, 10);
    }
    const dateObj = new Date(dateTimeStr);
    return dateObj.toISOString().slice(0, 10); // YYYY-MM-DD
  }

  // JWT í† í°ì—ì„œ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
  function getUserIdFromToken(token) {
    try {
      const parts = token.split('.');
      if (parts.length !== 3) {
        throw new Error("Invalid token");
      }
      // payloadëŠ” ë‘ ë²ˆì§¸ ë¶€ë¶„
      const payload = parts[1];
      // Base64 ë””ì½”ë”© (URL-safe ë³€í™˜ ì²˜ë¦¬)
      const decodedPayload = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
      const payloadObj = JSON.parse(decodedPayload);
      // 'sub' ë˜ëŠ” 'userId' í•„ë“œë¥¼ ì‚¬ìš© (í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •)
      return payloadObj.sub || payloadObj.userId;
    } catch (e) {
      console.error("í† í° íŒŒì‹± ì˜¤ë¥˜:", e);
      return null;
    }
  }

  async function fetchChatHistory(chatRoomId) {
    if (!chatRoomId || isNaN(chatRoomId)) {
      console.error("ğŸš¨ ì˜¤ë¥˜: ì˜ëª»ëœ chatRoomId ê°’:", chatRoomId);
      return;
    }

    const token = document.getElementById('tokenInput').value;
    if (!token) {
      console.error("ğŸš¨ í† í° ì—†ìŒ!");
      return;
    }

    try {
      const response = await fetch(`/api/bids/chats/${chatRoomId}`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
        }
      });

      if (!response.ok) {
        throw new Error(`ì´ì „ ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒíƒœ ì½”ë“œ: ${response.status}`);
      }

      const result = await response.json();
      console.log("âœ… ì´ì „ ì±„íŒ… ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:", result);

      if (result.data) {
        result.data.forEach(appendMessage);
      }
    } catch (error) {
      console.error("ğŸš¨ ì˜¤ë¥˜:", error);
    }
  }
</script>
</body>
</html>
